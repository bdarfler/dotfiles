#!/usr/bin/env bash
set -euo pipefail

# Convert non-mp3 media files to mp3 and remove the originals
for file in ~/Dropbox/Podcast/*.{mp4,m4a,m4b,wav,flac,ogg,wma,aac,opus}; do
	[ -f "$file" ] || continue
	mp3="${file%.*}.mp3"
	ffmpeg -i "$file" -q:a 2 "$mp3" && rm "$file"
done

# Set missing tags
for path in ~/Dropbox/Podcast/*.mp3; do
	[ -f "$path" ] || continue
	# If the file is missing title tag
	if [ -z "$(id3v2 -l "$path" | grep -E 'TI?T2')" ]; then
		# Pull filename from path
		file=${path##*/}
		# Strip suffix from filename
		base=${file%%.*}
		# Set the title tag to the filename
		id3v2 -2 --TIT2 "$base" "$path"
	fi
done

# Create xml feed
(cd ~/Dropbox/Podcast && dropcaster > podcast.xml)

# Sync with S3
aws s3 sync ~/Dropbox/Podcast s3://bdarfler-podcast \
  --delete \
  --profile podcast \
  --exclude .DS_Store
